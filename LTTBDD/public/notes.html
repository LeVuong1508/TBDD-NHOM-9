<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“’ Quáº£n lÃ½ ghi chÃº</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/share.css">

  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_utc);
  </script>
</head>
<body>
  <h2>ğŸ“’ Quáº£n lÃ½ ghi chÃº</h2>
  <button id="logoutBtn">ÄÄƒng xuáº¥t</button>

  <!-- Form thÃªm/sá»­a ghi chÃº -->
  <form id="note-form">
    <input type="hidden" id="noteId">
    <input type="text" id="title" placeholder="TiÃªu Ä‘á»" required>
    <textarea id="content" rows="4" placeholder="Ná»™i dung" required></textarea>
    <!-- HÃ ng nÃºt thao tÃ¡c -->
<div class="action-buttons">
  <!-- Chá»n file -->
  <div class="file-upload-wrapper">
  <input type="file" id="fileUpload" accept="image/*,video/*,audio/*" multiple>
  <label for="fileUpload" class="file-upload-btn">ğŸ“ Chá»n file</label>
  </div>

  <!-- Ghi Ã¢m -->
  <button type="button" id="startRecordBtn">ğŸ¤ Ghi Ã¢m</button>
  <button type="button" id="stopRecordBtn" disabled>â¹ Dá»«ng</button>

  <!-- Báº£n váº½ -->
  <button type="button" id="toggleDrawBtn">âœï¸ Báº£n váº½</button>
</div>

<!-- Preview file -->
<div id="filePreview" class="file-preview"></div>

<!-- Audio preview -->
<audio id="voicePreview" controls style="display:none;"></audio>

<!-- VÃ¹ng váº½ -->
<div id="drawAreaWrapper" style="display:none; margin-top:10px;">
  <canvas id="drawCanvas" width="600" height="400" style="border:1px solid #ccc; cursor:crosshair;"></canvas>
  <br>
  <button type="button" id="clearDrawBtn">ğŸ§¹ XÃ³a</button>
</div>

    <!-- ÄÃ¡nh dáº¥u quan trá»ng -->
    <div class="important-box">
      <label class="switch">
        <input type="checkbox" id="important">
        <span class="slider"></span>
      </label>
      <span class="important-label">â­ Quan trá»ng</span>
    </div>

    <button type="button" id="submitBtn" class="add-btn">ThÃªm ghi chÃº</button>
  </form>
  
  <!-- TÃ¬m kiáº¿m -->
  <input type="text" id="search" placeholder="TÃ¬m kiáº¿m ghi chÃº...">
  <button onclick="searchNotes()">ğŸ” TÃ¬m</button>
  <button id="btnViewShares">ğŸ“© Xem ghi chÃº Ä‘Æ°á»£c chia sáº»</button>
  <div id="shareList"></div>

  <div id="notes"></div>

  <!-- Modal chi tiáº¿t -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h3 id="detailTitle"></h3>
      <p id="detailContent"></p>
      <div class="file-preview" id="detailFile"></div>
      <p><b>â­ Quan trá»ng:</b> <span id="detailImportant"></span></p>
      <p>ğŸ•’ <b>Táº¡o lÃºc:</b> <span id="detailCreated"></span></p>
      <p>ğŸ”„ <b>Cáº­p nháº­t:</b> <span id="detailUpdated"></span></p>

       <!-- Action bar Ä‘áº·t nÃºt -->
    <div id="detailActions" style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
      <button id="toggleDeleteBtn">ğŸ—‘ï¸ Cháº¿ Ä‘á»™ xÃ³a file</button>
      <button id="confirmDeleteBtn" style="display:none;"> XÃ³a file Ä‘Ã£ chá»n</button>
      <button id="exitDeleteBtn" style="display:none;"> ThoÃ¡t cháº¿ Ä‘á»™ xÃ³a</button>
    </div>
    </div>
  </div>

<!-- SHARE -->
<div id="overlay" style="display:none;"></div>

<div id="sharePopup" style="display:none;">
  <h3>Chia sáº» ghi chÃº</h3>
  <input type="text" id="shareEmail" placeholder="Nháº­p email ngÆ°á»i nháº­n">
  <div id="recentEmails"></div>
  <button id="sendShareBtn">Gá»­i</button>
  <button id="cancelShareBtn">Há»§y</button>
</div>

  <!-- Overlay xem áº£nh lá»›n -->
  <div id="imageOverlay">
    <span onclick="closeImageOverlay()">&times;</span>
    <img id="overlayImg" src="">
  </div>

<script>
const API_URL = "http://localhost:5000/api";
const token = localStorage.getItem("token");
if (!token) window.location.href = "login.html";

let editingNoteId = null;

// Format thá»i gian (UTC -> VN)
function formatDate(value) {
  return value
    ? dayjs.utc(value).format("DD-MM-YYYY HH:mm:ss")
    : "ChÆ°a cáº­p nháº­t";
}

// Láº¥y danh sÃ¡ch notes
async function getNotes() {
  const res = await fetch(`${API_URL}/notes`, {
    headers:{ "Authorization":"Bearer "+token }
  });
  return res.json();
}

// Render danh sÃ¡ch note
function renderNotes(notes){
  const notesContainer = document.getElementById("notes");
  notesContainer.innerHTML = "";
  if(!Array.isArray(notes)) return;

  notes.forEach(note=>{
    const div=document.createElement("div");
    div.className="note";

    let fileHtml="";
    if(note.attachments?.length){
      fileHtml = note.attachments.map(att=>{
        if(att.fileType==='image') 
          return `<img src="${att.filePath}" style="max-width:150px; display:block; margin-top:8px;">`;
        if(att.fileType==='video') 
          return `<video controls style="max-width:200px; display:block; margin-top:8px;"><source src="${att.filePath}" type="video/mp4"></video>`;
        if(att.fileType==='audio') 
          return `<audio controls style="display:block; margin-top:8px;"><source src="${att.filePath}" type="audio/mpeg"></audio>`;
        return `<a href="${att.filePath}" target="_blank">ğŸ“‚ ${att.fileName || "Tá»‡p Ä‘Ã­nh kÃ¨m"}</a>`;
      }).join("");
    }

    div.innerHTML = `
      <h3>${note.title}</h3>
      <p>${note.content?.length>50?note.content.substring(0,50)+"...":(note.content||"")}</p>
      ${fileHtml}
      <small>ğŸ•’ ${formatDate(note.createdAt)}</small><br>
      <small>â­ ${note.important?"Quan trá»ng":"BÃ¬nh thÆ°á»ng"}</small>
      <div class="actions">
        <button onclick="viewDetail(${note.id})">ğŸ‘ï¸ Xem</button>
        <button onclick="editNote(${note.id})">âœï¸ Sá»­a</button>
        <button onclick="deleteNote(${note.id})">ğŸ—‘ï¸ XÃ³a</button>
        <button onclick="toggleImportant(${note.id})">â­ Toggle</button>
        <button onclick="shareNoteUI(${note.id})">ğŸ”— Chia sáº»</button>
      </div>
    `;
    notesContainer.appendChild(div);
  });
}

async function loadNotes(){ renderNotes(await getNotes()); }

// Preview file
document.getElementById('fileUpload').addEventListener('change', e=>{
  const preview=document.getElementById('filePreview');
  preview.innerHTML="";
  Array.from(e.target.files).forEach(file=>{
    const url=URL.createObjectURL(file);
    let elem;
    if(file.type.startsWith('image/')) 
      elem=`<img src="${url}" style="max-width:150px;margin:5px;">`;
    else if(file.type.startsWith('video/')) 
      elem=`<video src="${url}" controls style="max-width:200px;margin:5px;"></video>`;
    else if(file.type.startsWith('audio/')) 
      elem=`<audio src="${url}" controls style="display:block;margin:5px;"></audio>`;
    else 
      elem=`<span>ğŸ“‚ ${file.name}</span>`;
    preview.innerHTML+=elem;
  });
});

function resetForm(clearFiles = true) {
  // Reset text field
  document.getElementById("title").value = "";
  document.getElementById("content").value = "";
  document.getElementById("important").checked = false;
  document.getElementById("noteId").value = "";

  // Reset file + preview (chá»‰ khi thÃªm má»›i, khÃ´ng pháº£i sá»­a)
  if (clearFiles) {
    document.getElementById("fileUpload").value = "";
    document.getElementById("filePreview").innerHTML = "";
    document.getElementById("voicePreview").src = "";
    document.getElementById("voicePreview").style.display = "none";
  }

  // Reset canvas (náº¿u cÃ³ báº£n váº½)
  if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Reset láº¡i nÃºt
  const submitBtn = document.getElementById("submitBtn");
  submitBtn.innerText = "ThÃªm ghi chÃº";
  submitBtn.className = "add-btn";
}

// ThÃªm/sá»­a note
document.getElementById("submitBtn").addEventListener("click", async () => {
  const id = document.getElementById("noteId").value;
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();
  const important = document.getElementById("important").checked;
  const files = document.getElementById("fileUpload").files;

  if (!title || !content) return alert("Vui lÃ²ng nháº­p tiÃªu Ä‘á» vÃ  ná»™i dung!");

  const url = id ? `${API_URL}/notes/edit/${id}` : `${API_URL}/notes/add`;
  const method = id ? "PUT" : "POST";

  try {
    // LÆ°u note cÆ¡ báº£n
    const res = await fetch(url, {
      method,
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ title, content, important })
    });

    const note = await res.json();
    if (!res.ok || !note.id) return alert(note.message || "Lá»—i lÆ°u ghi chÃº");

    // Chuáº©n bá»‹ upload file
    const formData = new FormData();
    Array.from(files).forEach(f => formData.append("files", f));

    // Náº¿u cÃ³ báº£n váº½ thÃ¬ thÃªm
    if (canvas && ctx) {
      const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      const isEmpty = [...pixels].every(ch => ch === 0);
      if (!isEmpty) {
        await new Promise(resolve => {
          canvas.toBlob(blob => {
            if (blob) {
              formData.append("files", new File([blob], `drawing_${Date.now()}.png`, { type: "image/png" }));
            }
            resolve();
          }, "image/png");
        });
      }
    }

    // Upload file náº¿u cÃ³
    if (formData.has("files")) {
      await fetch(`${API_URL}/notes/upload/${note.id}/multiple`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: formData
      });
    }

    alert(id ? "Cáº­p nháº­t thÃ nh cÃ´ng" : "ThÃªm thÃ nh cÃ´ng");
    resetForm(true);
    
    loadNotes();
  } catch (err) {
    console.error(err);
    alert("Lá»—i káº¿t ná»‘i tá»›i server");
  }
});


// Chá»‰nh sá»­a
function editNote(id){
  getNotes().then(notes=>{
    const n=notes.find(x=>x.id===id);
    if(!n) return;
    document.getElementById("noteId").value=n.id;
    document.getElementById("title").value=n.title;
    document.getElementById("content").value=n.content;
    document.getElementById("important").checked=n.important;
    document.getElementById("submitBtn").innerText="Cáº­p nháº­t ghi chÃº";
    document.getElementById("submitBtn").className="update-btn";
  });
}

// XÃ³a
async function deleteNote(id){
  if(!confirm("XÃ³a ghi chÃº nÃ y?")) return;
  try{
    const res=await fetch(`${API_URL}/notes/delete/${id}`,{
      method:"DELETE",
      headers:{ "Authorization":"Bearer "+token }
    });
    if(!res.ok) return alert("XÃ³a tháº¥t báº¡i");
    alert("XÃ³a thÃ nh cÃ´ng");
    loadNotes();
  }catch(err){
    console.error(err);
    alert("Lá»—i káº¿t ná»‘i tá»›i server");
  }
}

// Toggle important
async function toggleImportant(id){
  try{
    const res=await fetch(`${API_URL}/notes/important/${id}`,{
      method:"PUT",
      headers:{ "Authorization":"Bearer "+token }
    });
    if(!res.ok) return alert("KhÃ´ng thá»ƒ cáº­p nháº­t tráº¡ng thÃ¡i quan trá»ng");
    loadNotes();
  }catch(err){
    console.error(err);
    alert("Lá»—i káº¿t ná»‘i tá»›i server");
  }
}

async function viewDetail(id) {
  try {
    const res = await fetch(`${API_URL}/notes/${id}`, { 
      headers: { "Authorization": "Bearer " + token } 
    });
    if (!res.ok) return alert("KhÃ´ng thá»ƒ láº¥y ghi chÃº");
    const n = await res.json();

    // Set text info
    document.getElementById("detailTitle").innerText = n.title || "";
    document.getElementById("detailContent").innerText = n.content || "";
    document.getElementById("detailImportant").innerText = n.important ? "âœ”ï¸" : "âŒ";
    document.getElementById("detailCreated").innerText = formatDate(n.createdAt);
    document.getElementById("detailUpdated").innerText = formatDate(n.updatedAt);

    // Láº¥y vÃ¹ng hiá»ƒn thá»‹ file
    const f = document.getElementById("detailFile");
    f.innerHTML = "";
    f.style.maxHeight = "300px";
    f.style.overflowY = "auto";

    // Láº¥y cÃ¡c nÃºt hÃ nh Ä‘á»™ng (Ä‘Ã£ cÃ³ sáºµn trong HTML)
    const toggleBtn = document.getElementById("toggleDeleteBtn");
    const delBtn    = document.getElementById("confirmDeleteBtn");
    const exitBtn   = document.getElementById("exitDeleteBtn");

    // Reset tráº¡ng thÃ¡i nÃºt má»—i láº§n má»Ÿ modal
    toggleBtn.style.display = "inline-block";
    delBtn.style.display    = "none";
    exitBtn.style.display   = "none";

    if (Array.isArray(n.attachments) && n.attachments.length > 0) {
      // Táº¡o danh sÃ¡ch file
      const fileList = document.createElement("div");

      n.attachments.forEach(att => {
        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";
        wrapper.style.alignItems = "center";
        wrapper.style.gap = "10px";
        wrapper.style.marginBottom = "8px";

        // Checkbox áº©n máº·c Ä‘á»‹nh
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.value = att.filePath.split("/").pop();
        chk.style.display = "none";

        let elem;
        if (att.fileType === "image") {
          elem = document.createElement("img");
          elem.src = att.filePath;
          elem.style.maxWidth = "auto";
          elem.style.cursor = "pointer";
          elem.onclick = () => {
            document.getElementById("overlayImg").src = att.filePath;
            document.getElementById("imageOverlay").style.display = "flex";
          };
        } else if (att.fileType === "video") {
          elem = document.createElement("video");
          elem.controls = true;
          elem.style.maxWidth = "auto";
          elem.innerHTML = `<source src="${att.filePath}" type="video/mp4">`;
        } else if (att.fileType === "audio") {
          elem = document.createElement("audio");
          elem.controls = true;
          elem.style.width = "100%";
          elem.innerHTML = `<source src="${att.filePath}" type="audio/mpeg">`;
        } else {
          elem = document.createElement("a");
          elem.href = att.filePath;
          elem.target = "_blank";
          elem.innerText = "ğŸ“‚ " + (att.fileName || "Tá»‡p Ä‘Ã­nh kÃ¨m");
        }

        wrapper.appendChild(chk);
        wrapper.appendChild(elem);
        fileList.appendChild(wrapper);
      });

      f.appendChild(fileList);

      // Sá»± kiá»‡n: báº­t cháº¿ Ä‘á»™ xÃ³a
      toggleBtn.onclick = () => {
        toggleBtn.style.display = "none";
        delBtn.style.display = "inline-block";
        exitBtn.style.display = "inline-block";
        f.querySelectorAll("input[type=checkbox]").forEach(chk => {
          chk.style.display = "inline-block";
        });
      };

      // Sá»± kiá»‡n: thoÃ¡t cháº¿ Ä‘á»™ xÃ³a
      exitBtn.onclick = () => {
        toggleBtn.style.display = "inline-block";
        delBtn.style.display = "none";
        exitBtn.style.display = "none";
        f.querySelectorAll("input[type=checkbox]").forEach(chk => {
          chk.checked = false;
          chk.style.display = "none";
        });
      };

      // Sá»± kiá»‡n: xÃ³a file Ä‘Ã£ chá»n
      delBtn.onclick = async () => {
        const selected = Array.from(f.querySelectorAll("input[type=checkbox]:checked"))
                              .map(chk => chk.value);
        if (selected.length === 0) return alert("ChÆ°a chá»n file nÃ o!");
        if (!confirm(`Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a ${selected.length} file?`)) return;

        await fetch(`${API_URL}/notes/${id}/delete-files`, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ files: selected })
        });

        alert("ÄÃ£ xÃ³a file!");
        viewDetail(id); // reload láº¡i modal
      };
    }

    // Hiá»‡n modal
    document.getElementById("detailModal").style.display = "flex";
  } catch (err) {
    console.error("Error in viewDetail:", err);
    alert("ÄÃ£ xáº£y ra lá»—i, xem console Ä‘á»ƒ debug");
  }
}


function closeModal() {
  document.getElementById("detailModal").style.display = "none";
}

function closeImageOverlay() {
  document.getElementById("imageOverlay").style.display = "none";
}

// Click ngoÃ i modal Ä‘á»ƒ Ä‘Ã³ng
window.onclick = (event) => {
  const modal = document.getElementById("detailModal");
  if (event.target === modal) closeModal();
};

document.getElementById("logoutBtn").onclick=()=>{
  localStorage.removeItem("token"); 
  window.location="login.html"; 
}

// TÃ¬m kiáº¿m
async function searchNotes(){
  const keyword=document.getElementById("search").value.trim();
  const notes=await getNotes();
  renderNotes(notes.filter(n=>n.title.includes(keyword)||n.content.includes(keyword)));
}

// ==== Ghi Ã¢m ====
let mediaRecorder;
let audioChunks = [];

const startBtn = document.getElementById("startRecordBtn");
const stopBtn = document.getElementById("stopRecordBtn");
const voicePreview = document.getElementById("voicePreview");

startBtn.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];

  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) audioChunks.push(e.data);
  };

  mediaRecorder.onstop = () => {
    const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
    const audioUrl = URL.createObjectURL(audioBlob);
    voicePreview.src = audioUrl;
    voicePreview.style.display = "block";

    // Add file vÃ o input
    const file = new File([audioBlob], `voice_${Date.now()}.mp3`, { type: 'audio/mpeg' });
    const fileInput = document.getElementById("fileUpload");
    const dt = new DataTransfer();
    Array.from(fileInput.files).forEach(f => dt.items.add(f));
    dt.items.add(file);
    fileInput.files = dt.files;
  };

  mediaRecorder.start();
  startBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = () => {
  if (mediaRecorder) mediaRecorder.stop();
  startBtn.disabled = false;
  stopBtn.disabled = true;
};

// Toggle vÃ¹ng váº½
document.getElementById("toggleDrawBtn").onclick = () => {
  const drawArea = document.getElementById("drawAreaWrapper");
  drawArea.style.display = drawArea.style.display === "none" ? "block" : "none";
};

// Váº½
const canvas = document.getElementById("drawCanvas");
const ctx = canvas.getContext("2d");
let drawing = false;

canvas.onmousedown = (e) => {
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
};
canvas.onmousemove = (e) => {
  if (!drawing) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;
  ctx.stroke();
};
canvas.onmouseup = () => drawing = false;
canvas.onmouseleave = () => drawing = false;

document.getElementById("clearDrawBtn").onclick = () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
};

// Trong hÃ m thÃªm/sá»­a note:
async function saveNote() {
  // ... cÃ¡c dá»¯ liá»‡u khÃ¡c ...
  const formData = new FormData();

  // Náº¿u cÃ³ váº½ gÃ¬ trong canvas â†’ thÃªm file
  const blank = document.createElement("canvas");
  blank.width = canvas.width;
  blank.height = canvas.height;
  const isEmpty = ctx.getImageData(0, 0, canvas.width, canvas.height)
                   .data.every(ch => ch === 0);

  if (!isEmpty) {
    await new Promise(resolve => {
      canvas.toBlob((blob) => {
        const file = new File([blob], `drawing_${Date.now()}.png`, { type: "image/png" });
        formData.append("files", file);
        resolve();
      });
    });
  }

}

// ==========================
// LÆ°u 5 email gáº§n Ä‘Ã¢y
let recentEmails = JSON.parse(localStorage.getItem("recentEmails") || "[]");

function shareNoteUI(noteId) {
  const popup = document.getElementById("sharePopup");
  const overlay = document.getElementById("overlay");
  const emailInput = document.getElementById("shareEmail");
  const recentDiv = document.getElementById("recentEmails");
  const sendBtn = document.getElementById("sendShareBtn");
  const cancelBtn = document.getElementById("cancelShareBtn");

  // Hiá»ƒn thá»‹ popup
  popup.style.display = "block";
  overlay.style.display = "block";
  emailInput.value = "";

  // Hiá»ƒn thá»‹ recent emails
  recentDiv.innerHTML = "";
  recentEmails.forEach(e => {
    const span = document.createElement("span");
    span.textContent = e;
    span.className = "recent-email";
    span.style.cursor = "pointer";
    span.style.marginRight = "5px";
    span.style.padding = "2px 4px";
    span.style.background = "#eee";
    span.style.borderRadius = "4px";
    span.addEventListener("click", () => {
      emailInput.value = e;
    });
    recentDiv.appendChild(span);
  });

  // Gá»­i
  sendBtn.onclick = async () => {
    const email = emailInput.value.trim();
    if (!email) return alert("Nháº­p email ngÆ°á»i nháº­n!");

    try {
      const res = await fetch(`${API_URL}/shares/${noteId}/share`, {
        method: "POST",
        headers: { 
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ email })
      });

      const data = await res.json();
      if (!res.ok) return alert("KhÃ´ng thá»ƒ chia sáº»: " + data.message);

      alert(" ÄÃ£ gá»­i yÃªu cáº§u share!");
      loadNotes();

      // LÆ°u vÃ o recent emails
      recentEmails = [email, ...recentEmails.filter(x => x !== email)].slice(0,5);
      localStorage.setItem("recentEmails", JSON.stringify(recentEmails));

      popup.style.display = "none";
      overlay.style.display = "none";
    } catch (err) {
      console.error("Lá»—i share:", err);
      alert("Lá»—i server khi share");
    }
  };

  // Há»§y
  cancelBtn.onclick = overlay.onclick = () => {
    popup.style.display = "none";
    overlay.style.display = "none";
  };
}




const shareListDiv = document.getElementById("shareList");
const btnViewShares = document.getElementById("btnViewShares");

btnViewShares.addEventListener("click", async () => {
  // Náº¿u Ä‘ang hiá»ƒn thá»‹ thÃ¬ áº©n luÃ´n
  if (shareListDiv.style.display === "block") {
    shareListDiv.style.display = "none";
    return;
  }

  // NgÆ°á»£c láº¡i, hiá»ƒn thá»‹ danh sÃ¡ch
  try {
    const res = await fetch("/api/shares/", {
      headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
    });
    const shares = await res.json();

    shareListDiv.innerHTML = "";

    if (shares.length === 0) {
      shareListDiv.innerHTML = "<p>ChÆ°a cÃ³ ghi chÃº nÃ o Ä‘Æ°á»£c chia sáº» vá»›i báº¡n</p>";
    } else {
      shares.forEach(s => {
        const div = document.createElement("div");
        div.innerHTML = `
          <p><strong>${s.title}</strong> tá»« ${s.fromEmail} | 
          <button onclick="acceptShare(${s.id})">Cháº¥p nháº­n</button> 
          <button onclick="rejectShare(${s.id})">Tá»« chá»‘i</button></p>
        `;
        shareListDiv.appendChild(div);
      });
    }

    shareListDiv.style.display = "block"; // hiá»ƒn thá»‹
  } catch (err) {
    console.error(err);
  }
});

// Cháº¥p nháº­n share
async function acceptShare(id) {
  await fetch(`/api/shares/${id}/accept`, {
    method: "POST",
    headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
  });
  alert("ÄÃ£ nháº­n ghi chÃº!");
  btnViewShares.click(); // reload list vÃ  toggle
  loadNotes();
}

// Tá»« chá»‘i share
async function rejectShare(id) {
  await fetch(`/api/shares/${id}/reject`, {
    method: "POST",
    headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
  });
  alert("ÄÃ£ tá»« chá»‘i ghi chÃº!");
  btnViewShares.click(); // reload list vÃ  toggle
}

loadNotes();
</script>
</body>
</html>
